{% extends "layouts/base.html" %} {% block title %} Dashboard {% endblock %} {%
block stylesheets %}
<style>
    .card {
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
    }

    .card-header {
        width: 100%;
        text-align: left;
    }

    .camera-preview {
        display: block;
        margin: 10px;
    }

    .detect-container {
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .dropdown-menu {
        width: 100%;
    }
</style>
{% endblock stylesheets %} {% block content %}
<div class="pcoded-main-container">
    <div class="pcoded-wrapper">
        <div class="pcoded-content">
            <div class="pcoded-inner-content">
                <div class="main-body">
                    <div class="page-wrapper">
                        <!-- Card for live streaming from admin (without detection) -->
                        <div class="card">
                            <div class="card-header">
                                <h5>Monitoring Kamera Ekspresi (*Real Time)</h5>
                            </div>
                            <div class="card-block px-0 py-3">
                                <div class="table-responsive">
                                    <img id="liveStreamExpression" class="camera-preview" width="800" height="500" />
                                </div>
                            </div>
                        </div>

                        <!-- Card for live streaming from admin (without detection) -->
                        <div class="card">
                            <div class="card-header">
                                <h5>Monitoring Kamera Pose (*Real Time)</h5>
                            </div>
                            <div class="card-block px-0 py-3">
                                <div class="table-responsive">
                                    <img id="liveStreamPose" class="camera-preview" width="800" height="500" />
                                </div>
                            </div>
                        </div>

                        <!-- Card for live detection results from admin -->
                        <div class="card">
                            <div class="card-header">
                                <h5>Hasil Deteksi Kamera Ekspresi & Pose (*Real Time)</h5>
                            </div>
                            <div class="card-block px-0 py-3">
                                <div class="table-responsive detect-container">
                                    <canvas id="expressionCanvas" width="400" height="275"></canvas>
                                    <canvas id="poseCanvas" width="400" height="275"></canvas>
                                </div>
                            </div>
                        </div>

                        <!-- Riwayat Emosi Section -->
                        <div class="row">
                            <!-- Card Riwayat Emosi Anak -->
                            <div class="col-md-8 col-xl-8">
                                <div class="card Recent-Users">
                                    <div class="card-header">
                                        <h5>Riwayat Emosi Anak</h5>
                                    </div>
                                    <div class="card-block px-0 py-3">
                                        <div class="table-responsive">
                                            <table class="table table-hover">
                                                <thead>
                                                    <tr>
                                                        <th>Timestamp</th>
                                                        <th>Emotion</th>
                                                        <th>Jumlah</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="emotionHistoryBody">
                                                    <!-- Dynamic Emotion History -->
                                                </tbody>
                                            </table>
                                            <div class="pagination">
                                                <button id="prevBtn" class="btn btn-primary" disabled>Previous</button>
                                                <button id="nextBtn" class="btn btn-primary">Next</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Card Pilih Siswa -->
                            <div class="col-md-4 col-xl-4">
                                <div class="card card-social">
                                    <div class="card-block border-bottom">
                                        <div class="row align-items-center">
                                            <div class="col-auto">
                                                <img class="rounded-circle" style="width: 50px"
                                                    src="{{ config.ASSETS_ROOT }}/images/logo.png" alt="Logo" />
                                            </div>
                                            <div class="col">
                                                <h5 class="text-c-blue mb-0">Pilih Siswa</h5>
                                            </div>
                                        </div>
                                        <div class="row align-items-center mt-3">
                                            <div class="col-12 text-center">
                                                <div class="dropdown">
                                                    <button class="btn btn-secondary dropdown-toggle" type="button"
                                                        id="dropdownMenuButton" data-toggle="dropdown"
                                                        aria-haspopup="true" aria-expanded="false">
                                                        Pilih Siswa
                                                    </button>
                                                    <div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
                                                        {% for siswa in all_siswa %}
                                                        <a class="dropdown-item" href="#">{{ siswa.name }}</a>
                                                        {% endfor %}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock content %} {% block javascripts %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.js"></script>
<script>
    const emotionHistoryBody = document.getElementById("emotionHistoryBody");
    const totalEmotionCount = document.getElementById("totalEmotionCount");

    window.onload = function () {
        const expressionCanvas = document.getElementById("expressionCanvas");
        const poseCanvas = document.getElementById("poseCanvas");
        const liveStreamExpression = document.getElementById("liveStreamExpression");
        const liveStreamPose = document.getElementById("liveStreamPose");
        const expressionCtx = expressionCanvas.getContext("2d");
        const poseCtx = poseCanvas.getContext("2d");

        const socket = io.connect(
            location.protocol + "//" + document.domain + ":" + location.port
        );

        socket.on("expression_frame", function (data) {
            const image = new Image();
            image.src = "data:image/jpeg;base64," + data.expression_image;
            image.onload = function () {
                expressionCtx.clearRect(
                    0,
                    0,
                    expressionCanvas.width,
                    expressionCanvas.height
                );
                expressionCtx.drawImage(
                    image,
                    0,
                    0,
                    expressionCanvas.width,
                    expressionCanvas.height
                );
            };
            image.onerror = function () {
                console.error("Error loading expression image");
            };
        });

        socket.on("pose_frame", function (data) {
            const image = new Image();
            image.src = "data:image/jpeg;base64," + data.pose_image;
            image.onload = function () {
                poseCtx.clearRect(0, 0, poseCanvas.width, poseCanvas.height);
                poseCtx.drawImage(image, 0, 0, poseCanvas.width, poseCanvas.height);
            };
            image.onerror = function () {
                console.error("Error loading pose image");
            };
        });

        socket.on("raw_expression", function (data) {
            if (data.raw_expression) {
                liveStreamExpression.src = "data:image/jpeg;base64," + data.raw_expression;
            } else {
                console.error("No raw expression image received");
            }
        });
        socket.on("raw_pose", function (data) {
            if (data.raw_pose) {
                liveStreamPose.src = "data:image/jpeg;base64," + data.raw_pose;
            } else {
                console.error("No raw pose image received");
            }
        });
    };

    function fetchEmotionHistory() {
        fetch('/emotion_history', {
            method: 'GET'
        })
            .then(response => response.json())
            .then(data => {
                // Clear the current table content
                emotionHistoryBody.innerHTML = '';

                // Populate the table with new data
                const emotions = data.emotion_count;
                const startTime = data.start_time;
                const endTime = data.end_time;

                // Add each emotion entry to the table
                for (let emotion in emotions) {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                    <td>${startTime} - ${endTime}</td>
                    <td>${emotion}</td>
                    <td>${emotions[emotion]}</td>
                `;
                    emotionHistoryBody.appendChild(row);
                }

                // Update the total emotion count
                const totalCount = Object.values(emotions).reduce((sum, count) => sum + count, 0);
                totalEmotionCount.textContent = totalCount;
            })
            .catch(error => console.error('Error fetching emotion history:', error));
    }

    // Fetch emotion history on page load
    fetchEmotionHistory();

    // Optionally, refresh the emotion history every minute
    setInterval(fetchEmotionHistory, 10000);
</script>
{% endblock javascripts %}